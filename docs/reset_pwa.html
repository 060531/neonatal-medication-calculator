<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reset PWA Cache</title>
</head>
<body style="font-family:system-ui,Segoe UI,Arial; padding:24px; line-height:1.6">
  <h2>กำลังล้าง Service Worker / Cache / Storage…</h2>
  <p>หน้านี้ใช้สำหรับ “แก้เว็บค้าง/ไม่อัปเดต” แบบเด็ดขาด</p>
  <pre id="log" style="background:#f6f6f6;padding:12px;border-radius:10px;white-space:pre-wrap"></pre>

<script>
(async () => {
  const log = (m) => (document.getElementById("log").textContent += m + "\n");
  try {
    log("1) Unregister service workers…");
    if ("serviceWorker" in navigator) {
      const regs = await navigator.serviceWorker.getRegistrations();
      for (const r of regs) await r.unregister();
      log("   - removed: " + regs.length);
    } else {
      log("   - no serviceWorker API");
    }

    log("2) Clear Cache Storage…");
    if (window.caches) {
      const keys = await caches.keys();
      for (const k of keys) await caches.delete(k);
      log("   - deleted caches: " + keys.length);
    }

    log("3) Clear Local/Session storage…");
    try { localStorage.clear(); } catch {}
    try { sessionStorage.clear(); } catch {}
    log("   - done");

    log("4) Clear IndexedDB (best effort) …");
    if (indexedDB && indexedDB.databases) {
      const dbs = await indexedDB.databases();
      for (const db of dbs) {
        if (db && db.name) indexedDB.deleteDatabase(db.name);
      }
      log("   - deleted dbs: " + dbs.length);
    } else {
      log("   - indexedDB.databases() not supported (ok)");
    }

    log("✅ Finished. Redirecting…");
    // กลับหน้า Home แบบ “ปิด SW ชั่วคราว” เพื่อเช็คว่าเว็บอัปเดตจริง
    location.replace("./index.html?nosw=1&v=" + Date.now());
  } catch (e) {
    console.error(e);
    log("❌ ERROR: " + (e && e.message ? e.message : e));
    log("ลองเปิดหน้าใหม่ด้วย Ctrl+Shift+R แล้วเปิด reset_pwa.html อีกครั้ง");
  }
})();
</script>
</body>
</html>
