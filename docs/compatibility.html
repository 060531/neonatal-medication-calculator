<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>Drug Compatibility (Static)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin:0;
      padding:0;
      background:#f3f4f6;
      color:#0f172a;
    }
    .page{
      max-width: 960px;
      margin: 24px auto 32px;
      padding: 16px;
    }
    h1{
      text-align:center;
      font-size:24px;
      margin-bottom:16px;
    }
    .card{
      background:#fff;
      border-radius:14px;
      box-shadow:0 8px 18px rgba(15,23,42,.12);
      padding:16px 18px 20px;
    }
    label{
      font-weight:600;
      display:block;
      margin-bottom:6px;
    }
    select{
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid #cbd5e1;
      font-size:14px;
      margin-bottom:10px;
    }
    .form-row{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    @media(min-width:720px){
      .form-row{
        flex-direction:row;
      }
      .form-col{
        flex:1;
      }
    }
    button{
      margin-top:6px;
      display:inline-block;
      padding:8px 16px;
      border-radius:10px;
      border:none;
      font-weight:700;
      cursor:pointer;
      background:#0ea5e9;
      color:#fff;
    }
    button:hover{
      filter:brightness(0.95);
    }
    .result{
      margin-top:16px;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      font-size:14px;
    }

    .C{ background:rgba(22,163,74,.08); border-color:#16a34a; color:#065f46; }
    .I{ background:rgba(220,38,38,.08); border-color:#dc2626; color:#7f1d1d; }
    .U{ background:rgba(245,158,11,.10); border-color:#f59e0b; color:#78350f; }
    .ND{ background:rgba(37,99,235,.10); border-color:#2563eb; color:#1e3a8a; }
    .error{ background:#fee2e2; border-color:#ef4444; color:#991b1b; }
    .legend{
      margin-top:10px;
      font-size:12px;
      color:#4b5563;
      display:flex;
      flex-wrap:wrap;
      gap:8px 16px;
    }
    .dot{
      display:inline-block;
      width:10px;
      height:10px;
      border-radius:50%;
      margin-right:4px;
    }
    .dot.C{ background:#16a34a; }
    .dot.I{ background:#dc2626; }
    .dot.U{ background:#f59e0b; }
    .dot.ND{ background:#2563eb; }
  </style>
</head>
<body>
  <div class="page">
    <h1>ตรวจสอบความเข้ากันได้ของยา (Static JSON)</h1>

    <div class="card">
      <form id="compat-form">
        <div class="form-row">
          <div class="form-col">
            <label for="drug_a">ยา A</label>
            <select id="drug_a" required>
              <option value="">-- เลือกยา --</option>
            </select>
          </div>
          <div class="form-col">
            <label for="drug_b">ยา B</label>
            <select id="drug_b" required>
              <option value="">-- เลือกยา --</option>
            </select>
          </div>
        </div>
        <button type="submit">ตรวจสอบ</button>
      </form>

      <div id="compat-result" class="result ND" style="display:none;"></div>

      <div class="legend">
        <span><span class="dot C"></span> C = Compatible / ผสมร่วมได้</span>
        <span><span class="dot I"></span> I = Incompatible / ห้ามผสม</span>
        <span><span class="dot U"></span> U = Uncertain / ไม่ชัดเจน</span>
        <span><span class="dot ND"></span> ND = No data / ไม่มีข้อมูล</span>
      </div>
    </div>
  </div>

  <script>
    // ตำแหน่งไฟล์ JSON บน GitHub Pages
    // compatibility.html อยู่ที่ docs/
    // seed อยู่ที่ docs/data/seed_compatibility.json
    const DATA_URL = 'data/seed_compatibility.json';

    let compatRows = [];
    let loaded = false;

    function normalize(s){
      return String(s || '').trim().toLowerCase();
    }

    function statusCode(s){
      if(!s) return 'ND';
      const t = String(s).trim().toLowerCase();
      if(t.startsWith('c')) return 'C';
      if(t.startsWith('i')) return 'I';
      if(t.startsWith('u')) return 'U';
      if(t === 'nd' || t.includes('no data') || t.includes('ไม่มีข้อมูล')) return 'ND';
      return s.toUpperCase();
    }

    function showResultBox(type, html){
      const box = document.getElementById('compat-result');
      box.style.display = 'block';
      box.className = 'result ' + type;
      box.innerHTML = html;
      box.scrollIntoView({ behavior:'smooth', block:'center' });
    }

    // โหลด JSON แล้วเติม <option> ใน select
    fetch(DATA_URL)
      .then(resp => {
        if(!resp.ok){
          throw new Error('ไม่สามารถโหลด ' + DATA_URL + ' (' + resp.status + ')');
        }
        return resp.json();
      })
      .then(data => {
        compatRows = Array.isArray(data) ? data : [];
        loaded = true;

        const names = new Set();
        compatRows.forEach(row => {
          if(row.drug) names.add(row.drug);
          if(row.co_drug) names.add(row.co_drug);
        });

        const sorted = Array.from(names).sort((a,b) =>
          a.localeCompare(b, 'en', { sensitivity:'base' })
        );

        const selA = document.getElementById('drug_a');
        const selB = document.getElementById('drug_b');

        sorted.forEach(name => {
          const optA = document.createElement('option');
          optA.value = name;
          optA.textContent = name;
          selA.appendChild(optA);

          const optB = document.createElement('option');
          optB.value = name;
          optB.textContent = name;
          selB.appendChild(optB);
        });
      })
      .catch(err => {
        console.error('Fetch error:', err);
        showResultBox('error', 'เกิดข้อผิดพลาดในการโหลดข้อมูลยา: ' + err.message);
      });

    // เมื่อกดปุ่ม "ตรวจสอบ"
    document.getElementById('compat-form').addEventListener('submit', function(ev){
      ev.preventDefault();

      if(!loaded){
        showResultBox('error', 'กำลังโหลดข้อมูลยา กรุณาลองใหม่อีกครั้ง');
        return;
      }

      const a = document.getElementById('drug_a').value;
      const b = document.getElementById('drug_b').value;

      if(!a || !b){
        showResultBox('error', 'กรุณาเลือกยาทั้งสองตัว');
        return;
      }
      if(a === b){
        showResultBox('error', 'กรุณาเลือกยาคนละชนิดกัน');
        return;
      }

      const na = normalize(a);
      const nb = normalize(b);

      let found = null;
      for(const row of compatRows){
        const r1 = normalize(row.drug);
        const r2 = normalize(row.co_drug);
        if((r1 === na && r2 === nb) || (r1 === nb && r2 === na)){
          found = row;
          break;
        }
      }

      if(!found){
        showResultBox('ND',
          `<p><b>${a}</b> + <b>${b}</b> → <b>ND</b></p>
           <p>No data / ไม่มีข้อมูลในฐาน static</p>`
        );
        return;
      }

      const code = statusCode(found.status);
      const legend = {
        C: 'Compatible / ผสมร่วมได้',
        I: 'Incompatible / ห้ามผสม',
        U: 'Uncertain / ไม่ชัดเจน',
        ND: 'No data / ไม่มีข้อมูล'
      };

      let html = `
        <p><b>${found.drug}</b> + <b>${found.co_drug}</b> → <b>${code}</b></p>
        <p>${found.note || legend[code] || ''}</p>
      `;
      if(found.source){
        html += `<p style="font-size:12px;">อ้างอิง: ${found.source}</p>`;
      }

      showResultBox(code, html);
    });
  </script>
</body>
</html>
