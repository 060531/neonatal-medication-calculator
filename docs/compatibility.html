<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>ตรวจสอบความเข้ากันได้ของยา (Compatibility)</title>

  <style>
    :root{
      --blue-900:#0069b3;
      --blue-700:#0091d8;
      --sky-50:#e7f4ff;
      --panel:#ffffffee;
      --text:#0f172a;
      --danger:#e11d48;
      --ok:#16a34a;
      --warn:#f97316;
      --muted:#64748b;
    }
    *{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;}
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      background-image:url('https://cdn.jsdelivr.net/gh/060531/images/IMG_4200.jpeg');
      background-size:cover;
      background-position:center;
      background-attachment:fixed;
      color:var(--text);
    }
    .page-wrap{
      width:100%;
      max-width:960px;
      padding:24px 12px 40px;
    }
    .card{
      max-width:760px;
      margin:0 auto;
      background:linear-gradient(180deg,#f5fbff 0%,#eef7ff 40%,#fdfdff 100%);
      border-radius:18px;
      box-shadow:0 16px 40px rgba(15,23,42,.18);
      padding:22px 18px 24px;
      backdrop-filter:blur(6px);
    }
    @media (min-width:768px){
      .card{padding:26px 28px 28px;}
    }
    .title-badge{
      display:inline-block;
      margin:0 auto 18px;
      padding:10px 32px;
      border-radius:999px;
      background:linear-gradient(90deg,var(--blue-900),var(--blue-700));
      color:#fff;
      font-size:18px;
      font-weight:700;
      text-align:center;
      box-shadow:0 16px 32px rgba(2,6,23,.4);
    }
    .title-badge small{display:block;font-size:13px;font-weight:400;opacity:.9;}
    .grid-two{
      display:grid;
      grid-template-columns:1fr;
      gap:14px;
    }
    @media (min-width:720px){
      .grid-two{grid-template-columns:1fr 1fr;gap:18px;}
    }
    label{
      display:block;
      font-weight:600;
      margin-bottom:4px;
      font-size:14px;
    }
    select{
      width:100%;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid #cbd5e1;
      outline:none;
      font-size:14px;
      background:#fff;
      box-shadow:0 2px 5px rgba(15,23,42,.06);
    }
    select:focus{border-color:var(--blue-700);box-shadow:0 0 0 2px rgba(56,189,248,.5);}
    .actions{
      margin:16px 0 8px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:center;
    }
    button{
      border:none;
      border-radius:999px;
      padding:9px 24px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      box-shadow:0 6px 12px rgba(15,23,42,.18);
      transition:transform .12s ease, box-shadow .12s ease, background .12s ease;
    }
    .btn-primary{
      background:linear-gradient(90deg,#059669,#22c55e);
      color:#fff;
    }
    .btn-secondary{
      background:#ffffff;
      color:var(--blue-900);
      border:1px solid #dbeafe;
      box-shadow:0 4px 10px rgba(15,23,42,.12);
    }
    button:active{
      transform:translateY(1px);
      box-shadow:0 3px 6px rgba(15,23,42,.25);
    }

    .result-box{
      margin-top:10px;
      border-radius:14px;
      border:1px solid #e2e8f0;
      background:#f8fafcdd;
      padding:14px 14px 10px;
      min-height:72px;
      font-size:14px;
    }
    .result-header{
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom:4px;
      flex-wrap:wrap;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:90px;
      padding:4px 12px;
      border-radius:999px;
      font-size:13px;
      font-weight:700;
      color:#fff;
    }
    .pill-C{background:var(--ok);}
    .pill-I{background:var(--danger);}
    .pill-U{background:var(--warn);}
    .pill-ND{background:var(--muted);}
    .result-detail{font-size:13px;color:#0f172a;}
    .result-note{margin-top:4px;font-size:12px;color:#475569;}
    .legend{
      margin-top:10px;
      font-size:12px;
      color:#0f172a;
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      justify-content:center;
    }
    .legend span{display:inline-flex;align-items:center;gap:4px;}
    .dot{
      width:8px;height:8px;border-radius:999px;display:inline-block;
    }
    .dot-C{background:var(--ok);}
    .dot-I{background:var(--danger);}
    .dot-U{background:var(--warn);}
    .dot-ND{background:var(--muted);}
    .footer{
      margin-top:14px;
      text-align:center;
      font-size:11px;
      color:#e2e8f0;
      text-shadow:0 1px 3px rgba(15,23,42,.6);
    }
  </style>
</head>
<body>
  <div class="page-wrap">
    <div class="card">
      <h1 class="title-badge">
        ตรวจสอบความเข้ากันได้ของยา
        <small>(Compatibility)</small>
      </h1>

      <form id="compat-form">
        <div class="grid-two">
          <div>
            <label for="drugA">ยา A</label>
            <select id="drugA" required>
              <option value="">-- เลือกยา --</option>
            </select>
          </div>
          <div>
            <label for="drugB">ยา B</label>
            <select id="drugB" required>
              <option value="">-- เลือกยา --</option>
            </select>
          </div>
        </div>

        <div class="actions">
          <button type="submit" class="btn-primary">ตรวจสอบ</button>
          <button type="button" class="btn-secondary" onclick="window.location.href='index.html'">
            กลับหน้า Home
          </button>
        </div>
      </form>

      <div id="resultBox" class="result-box">
        <div class="result-header">
          <div id="pill" class="pill pill-ND">–</div>
          <div id="resultLabel">เลือกยาสองตัวแล้วกด “ตรวจสอบ”</div>
        </div>
        <div id="resultDetail" class="result-detail"></div>
        <div id="resultNote" class="result-note"></div>
      </div>

      <div class="legend">
        <span><span class="dot dot-C"></span> C = Compatible / ผสมร่วมได้</span>
        <span><span class="dot dot-I"></span> I = Incompatible / ห้ามผสม</span>
        <span><span class="dot dot-U"></span> U = Uncertain / ไม่ชัดเจน</span>
        <span><span class="dot dot-ND"></span> ND = No data / ไม่มีข้อมูล</span>
      </div>
    </div>

    <div class="footer">
      Developed by Sukhontha Boonsookchan | static compatibility viewer
    </div>
  </div>

  <script>
    // ============= Helper =============
    function normName(s){
      return String(s || "")
        .trim()
        .toLowerCase()
        .replace(/\s+/g," ");
    }

    function statusToCode(s){
      if(!s) return "ND";
      const t = String(s).trim().toLowerCase();
      if(t.startsWith("c") || ["เข้ากันได้","yes","true"].includes(t)) return "C";
      if(t.startsWith("i") || ["ไม่เข้ากัน","ห้ามผสม","ควรหลีกเลี่ยง","no","false"].includes(t)) return "I";
      if(t.startsWith("u") || ["ไม่แน่ชัด"].includes(t)) return "U";
      if(["nd","no data","ไม่มีข้อมูล","unknown"].includes(t)) return "ND";
      return "ND";
    }

    function codeToThaiText(code){
      switch(code){
        case "C": return "เข้ากันได้ / ผสมร่วมได้";
        case "I": return "ไม่เข้ากัน / ห้ามผสม";
        case "U": return "ข้อมูลไม่ชัดเจน (uncertain)";
        case "ND": return "ไม่มีข้อมูลในไฟล์ static";
        default: return "";
      }
    }

    // ============= Main =============
    (async function(){
      const selectA = document.getElementById("drugA");
      const selectB = document.getElementById("drugB");
      const form    = document.getElementById("compat-form");
      const pill    = document.getElementById("pill");
      const labelEl = document.getElementById("resultLabel");
      const detailEl= document.getElementById("resultDetail");
      const noteEl  = document.getElementById("resultNote");

      let rows = [];
      try{
        const res = await fetch("data/seed_compatibility.json");
        if(!res.ok) throw new Error("HTTP " + res.status);
        rows = await res.json();
      }catch(err){
        console.error("โหลดไฟล์ static ไม่สำเร็จ", err);
        pill.textContent = "ND";
        pill.className = "pill pill-ND";
        labelEl.textContent = "โหลดไฟล์ data/seed_compatibility.json ไม่สำเร็จ";
        detailEl.textContent = "โปรดตรวจสอบว่าไฟล์อยู่ในโฟลเดอร์ docs/data และ GitHub Pages deploy สำเร็จ";
        return;
      }

      // ดึงชื่อยาใช้ populate dropdown
      const nameSet = new Set();
      rows.forEach(r=>{
        if(r.drug) nameSet.add(r.drug);
        if(r.co_drug) nameSet.add(r.co_drug);
      });
      const names = Array.from(nameSet).sort((a,b)=>a.localeCompare(b));
      for(const name of names){
        const optA = document.createElement("option");
        optA.value = name;
        optA.textContent = name;
        selectA.appendChild(optA);

        const optB = document.createElement("option");
        optB.value = name;
        optB.textContent = name;
        selectB.appendChild(optB);
      }

      function findPair(nameA, nameB){
        const n1 = normName(nameA);
        const n2 = normName(nameB);
        if(!n1 || !n2 || n1 === n2) return null;
        const [x,y] = [n1,n2].sort();
        for(const r of rows){
          const [ra,rb] = [normName(r.drug), normName(r.co_drug)].sort();
          if(ra === x && rb === y){
            return r;
          }
        }
        return null;
      }

      form.addEventListener("submit", function(ev){
        ev.preventDefault();
        const a = selectA.value;
        const b = selectB.value;
        if(!a || !b){
          labelEl.textContent = "กรุณาเลือกยาทั้งสองตัว";
          pill.textContent = "ND";
          pill.className = "pill pill-ND";
          detailEl.textContent = "";
          noteEl.textContent = "";
          return;
        }
        if(a === b){
          labelEl.textContent = "กรุณาเลือกยาคนละชนิดกัน";
          pill.textContent = "ND";
          pill.className = "pill pill-ND";
          detailEl.textContent = "";
          noteEl.textContent = "";
          return;
        }

        const pair = findPair(a,b);
        if(!pair){
          const code = "ND";
          pill.textContent = code;
          pill.className = "pill pill-" + code;
          labelEl.textContent = codeToThaiText(code);
          detailEl.textContent = a + " + " + b;
          noteEl.textContent = "";
          return;
        }

        const code = statusToCode(pair.status);
        pill.textContent = code;
        pill.className = "pill pill-" + code;
        labelEl.textContent = codeToThaiText(code);
        detailEl.textContent = (pair.en || (a + " + " + b)) +
          (pair.th ? " | " + pair.th : "");
        noteEl.textContent = pair.note ? ("หมายเหตุ: " + pair.note) : "";
      });
    })();
  </script>
</body>
</html>
