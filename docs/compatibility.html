<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Drug Compatibility</title>
  <link rel="manifest" href="./static/manifest.webmanifest">
  <link rel="stylesheet" href="./static/style.css?v=2025-11-30-04">

  <style>
    body{
      font-family: Arial, Helvetica, sans-serif;
      margin:0; padding:0; text-align:center;
      background-image:url("https://cdn.jsdelivr.net/gh/060531/images/IMG_4200.jpeg");
      background-size:cover; background-position:center; background-repeat:no-repeat;
      min-height:100vh; display:flex; flex-direction:column; align-items:center;
      color:#0f172a;
    }
    .wrap{ max-width:860px; width:100%; padding:20px 12px; box-sizing:border-box; }
    h1{
      display:inline-block; margin:18px 0 14px; padding:12px 18px;
      color:#fff; border-radius:14px;
      background:linear-gradient(135deg,#039eac,#007a8c);
      text-shadow:2px 2px 6px rgba(0,0,0,.55);
    }
    .card{
      background:#ffffffea; border-radius:18px; padding:18px 14px;
      box-shadow:0 18px 45px rgba(15,23,42,.24);
      text-align:left;
    }
    label{ display:block; font-weight:700; margin:10px 0 6px; }
    select, button{
      width:100%; padding:12px 12px; border-radius:12px;
      border:1px solid #e5e7eb; font-size:16px; box-sizing:border-box;
    }
    button{
      margin-top:14px; border:none; cursor:pointer;
      background:#16a34a; color:#fff; font-weight:800;
    }
    .hint{ margin-top:10px; font-size:.92rem; color:#334155; }
    .err{ margin-top:10px; font-size:.92rem; color:#b91c1c; }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>ตรวจสอบความเข้ากันได้ของยา<br><span style="font-size:.9em;font-weight:600;">Drug Compatibility</span></h1>

    <div class="card">
      <form id="compatForm">
        <label for="drugA">Drug A</label>
        <select id="drugA" required>
          <option value="">— กำลังโหลดรายการยา… —</option>
        </select>

        <label for="drugB">Drug B</label>
        <select id="drugB" required>
          <option value="">— กำลังโหลดรายการยา… —</option>
        </select>

        <button type="submit">ตรวจสอบ (Check)</button>
        <div class="hint" id="hint"></div>
        <div class="err" id="err"></div>
      </form>
    </div>
  </div>

  <script>
    const VERSION = "2025-11-30-04";
    const jsonUrl = `./static/compat_lookup.json?v=${VERSION}`;
    const hintEl = document.getElementById("hint");
    const errEl  = document.getElementById("err");

    function canon(s){
      return (s || "").toString().trim().toLowerCase().replace(/\s+/g," ");
    }

    function extractDrugsFromLookup(map){
      const set = new Set();
      for (const k of Object.keys(map || {})) {
        if (!k.includes("|")) continue;
        const [a,b] = k.split("|");
        if (a) set.add(canon(a));
        if (b) set.add(canon(b));
      }
      return Array.from(set).sort((x,y)=>x.localeCompare(y));
    }

    function fillSelect(sel, items){
      sel.innerHTML = `<option value="">— เลือกยา —</option>` +
        items.map(v => `<option value="${v}">${v}</option>`).join("");
    }

    async function loadDrugs(){
      errEl.textContent = "";
      hintEl.textContent = "กำลังดึงรายการยาจากฐานข้อมูล (compat_lookup.json)…";

      const res = await fetch(jsonUrl, { cache: "no-store" });
      if (!res.ok) throw new Error("โหลด compat_lookup.json ไม่สำเร็จ");

      const map = await res.json();
      const drugs = extractDrugsFromLookup(map);

      if (!drugs.length) throw new Error("compat_lookup.json ไม่มีคีย์รูปแบบ a|b");

      fillSelect(document.getElementById("drugA"), drugs);
      fillSelect(document.getElementById("drugB"), drugs);
      hintEl.textContent = `พร้อมใช้งาน: พบรายชื่อยา ${drugs.length} รายการ`;
    }

    document.getElementById("compatForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const a = document.getElementById("drugA").value;
      const b = document.getElementById("drugB").value;
      if (!a || !b) return;

      const qs = new URLSearchParams({ drug_a: a, drug_b: b });
      location.href = `compatibility_result.html?${qs.toString()}`;
    });

    loadDrugs().catch(err => {
      errEl.textContent = "โหลดรายชื่อยาไม่สำเร็จ: " + err.message;
      hintEl.textContent = "";
      // fallback: ให้ยังเลือกได้บ้าง
      fillSelect(document.getElementById("drugA"), ["acyclovir","ampicillin","amikacin"]);
      fillSelect(document.getElementById("drugB"), ["acyclovir","ampicillin","amikacin"]);
    });
  </script>

  <script>
    (function () {
      if (!("serviceWorker" in navigator)) return;
      navigator.serviceWorker.register("./service-worker.js?v=2025-11-30-05", { scope: "./" })
        .catch(console.error);
    })();
  </script>
</body>
</html>
