<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Result analyze (Compatibility)</title>

  <meta name="theme-color" content="#0ea5a6" />
  <link rel="manifest" href="./static/manifest.webmanifest">
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <link rel="apple-touch-icon" href="./static/icons/icon-192.png">

  <link rel="stylesheet" href="./static/style.css">
  <script defer src="./static/app.js"></script>

  <style>
    :root{ color-scheme: light only; }
    html,body{ height:100%; }
    body{
      font-family: Arial, Helvetica, sans-serif;
      text-align:center; margin:0; padding:0;
      color:#228cb3;
      min-height:100vh;
      display:flex; flex-direction:column;
      align-items:center; justify-content:flex-start;
      background-image:url("https://cdn.jsdelivr.net/gh/060531/images/IMG_4200.jpeg");
      background-size:cover; background-position:center; background-repeat:no-repeat;
    }
    .container{
      max-width:1000px; width:100%; box-sizing:border-box;
      padding:20px; background:transparent;
      display:flex; flex-direction:column; align-items:center; gap:16px;
    }
    footer{
      margin-top:auto; color:#fff; font-size:16px; padding:10px;
      text-shadow:2px 2px 5px rgba(3,3,3,.7);
    }
    @media (max-width:600px){
      footer{ font-size:11px; padding:6px 4px; line-height:1.3; }
    }

    /* debug panel (ซ่อนเป็นค่าเริ่มต้น) */
    .dbg{
      margin-top:12px;
      text-align:left;
      width:min(900px, 100%);
      background:rgba(255,255,255,.92);
      border-radius:12px;
      padding:12px;
      box-shadow:0 6px 18px rgba(0,0,0,.15);
      font-size:12px;
      color:#0f172a;
      display:none;
      overflow:auto;
      max-height:240px;
    }
    .dbg code{ white-space:pre-wrap; }
    .dbg-toggle{
      margin-top:10px;
      border:none;
      padding:8px 12px;
      border-radius:10px;
      cursor:pointer;
    }
  </style>
</head>

<body>
  <div class="container">

    <div class="compat-shell">
      <h1 class="compat-title">
        ตรวจสอบความเข้ากันได้ของยา<br>
        <span>Drug Compatibility</span>
      </h1>

      <div class="compat-card compat-card-wide">
        <h2 class="compat-subtitle">Result analyze</h2>

        <div class="compat-result-header">
          <span class="compat-pill" data-drug-a>Drug A</span>
          <span class="compat-with">with</span>
          <span class="compat-pill" data-drug-b>Drug B</span>
        </div>

        <div class="compat-status-line">
          <span class="compat-status-pill" data-status-code>ND</span>
          <span class="compat-status-text" data-status-label>Unknown</span>
        </div>

        <hr>

        <div class="compat-note-block">
          <p class="compat-note-main" data-note-main>
            —
          </p>
          <p class="compat-note-ref" data-note-ref></p>
        </div>

        <div class="compat-legend" style="margin-top:20px">
          <span class="dot dot-c"></span> C = Compatible / ผสมร่วมได้
          • <span class="dot dot-i"></span> I = Incompatible / ห้ามผสม
          • <span class="dot dot-u"></span> U = Uncertain / ไม่ชัดเจน
          • <span class="dot dot-nd"></span> ND = No data / ไม่มีข้อมูล
        </div>

        <div class="compat-actions" style="margin-top:20px">
          <a href="compatibility.html" class="btn-check">↺ New check</a>
          <a href="index.html" class="btn-home">Home</a>
        </div>

        <button class="dbg-toggle" type="button" id="dbgBtn">ดู Debug</button>
        <div class="dbg" id="dbgBox"><code id="dbgText"></code></div>

      </div>
    </div>

  </div>

  <footer>
    <p>Developed by Sukhontha Boonsookchan | update</p>
  </footer>

<script>
(() => {
  const $ = (s) => document.querySelector(s);
  const dbgText = $("#dbgText");
  const dbgBox  = $("#dbgBox");
  const dbgBtn  = $("#dbgBtn");

  function logDbg(obj){
    if (!dbgText) return;
    dbgText.textContent += (typeof obj === "string" ? obj : JSON.stringify(obj, null, 2)) + "\n";
  }

  dbgBtn?.addEventListener("click", () => {
    if (!dbgBox) return;
    dbgBox.style.display = (dbgBox.style.display === "block") ? "none" : "block";
  });

  function canonBase(s){
    return (s ?? "")
      .toString()
      .normalize("NFKC")
      .trim()
      .toLowerCase()
      .replace(/[®™©]/g, "")         // ตัดสัญลักษณ์การค้า
      .replace(/\s+/g, " ");         // ช่องว่างซ้อน
  }

  // สร้าง candidate หลายแบบเพื่อลด mismatch ระหว่าง "ชื่อบน dropdown" กับ "key ใน JSON"
  function candidates(name){
    const s0 = canonBase(name);
    const set = new Set();

    const noParen = s0.replace(/\s*\([^)]*\)\s*/g, " ").replace(/\s+/g," ").trim();
    const slashTight = s0.replace(/\s*\/\s*/g, "/");
    const slashSpaced = s0.replace(/\s*\/\s*/g, " / ");
    const plusTight = s0.replace(/\s*\+\s*/g, "+");
    const plusSpaced = s0.replace(/\s*\+\s*/g, " + ");
    const hyphenSpace = s0.replace(/[-–—]/g, " ").replace(/\s+/g," ").trim();

    [s0, noParen, slashTight, slashSpaced, plusTight, plusSpaced, hyphenSpace].forEach(x => {
      if (x) set.add(x);
    });

    // เอาเว้นวรรคข้าง pipe ออกเสมอ
    return Array.from(set).map(x => x.replace(/\s*\|\s*/g, "|"));
  }

  function paint(code, note, source){
    const codeEl  = $("[data-status-code]");
    const labelEl = $("[data-status-label]");
    const noteEl  = $("[data-note-main]");
    const refEl   = $("[data-note-ref]");

    const map = {
      C: "Compatible / ผสมร่วมได้",
      I: "Incompatible / ห้ามผสม",
      U: "Uncertain / ไม่ชัดเจน",
      ND:"No data / ไม่มีข้อมูล"
    };
    const c = (code || "ND").toUpperCase();
    if (codeEl) codeEl.textContent = c;
    if (labelEl) labelEl.textContent = map[c] || "Unknown";
    if (noteEl) noteEl.textContent = note || "ยังไม่พบรายละเอียดคู่นี้ในระบบ (ตรวจคู่มืออีกครั้ง / สืบค้นเพิ่มเติม)";
    if (refEl) refEl.textContent = source ? `อ้างอิง: ${source}` : "";
  }

  async function loadDB(){
    const url = `./static/compat_lookup.json?v=${Date.now()}`;
    logDbg({fetch:url});
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error("fetch compat_lookup.json failed: " + res.status);
    return res.json();
  }

  async function main(){
    const params = new URLSearchParams(location.search);
    const drugA_raw = params.get("drug_a") || "";
    const drugB_raw = params.get("drug_b") || "";

    $("[data-drug-a]") && ($("[data-drug-a]").textContent = drugA_raw || "Drug A");
    $("[data-drug-b]") && ($("[data-drug-b]").textContent = drugB_raw || "Drug B");

    if (!drugA_raw || !drugB_raw){
      paint("ND", "กรุณาเลือกยา A และยา B", "");
      return;
    }

    let db;
    try {
      db = await loadDB();
    } catch (e) {
      console.error(e);
      paint("ND", "โหลดฐานข้อมูลไม่สำเร็จ (ตรวจสอบว่า compat_lookup.json อยู่ที่ ./static/ และเปิดได้แบบ 200)", "");
      logDbg({error:String(e)});
      return;
    }

    const A = candidates(drugA_raw);
    const B = candidates(drugB_raw);

    logDbg({drugA_raw, drugB_raw, A, B, db_keys: Object.keys(db).length});

    // ค้นหา match แบบ exhaustive (ลองหลายชื่อ + สลับข้าง)
    let found = null;
    let foundKey = null;

    for (const a of A){
      for (const b of B){
        const k1 = `${a}|${b}`;       // ห้ามมีช่องว่างรอบ |
        const k2 = `${b}|${a}`;
        if (db[k1]) { found = db[k1]; foundKey = k1; break; }
        if (db[k2]) { found = db[k2]; foundKey = k2; break; }
      }
      if (found) break;
    }

    logDbg({foundKey, found});

    if (!found){
      paint("ND", "ยังไม่พบรายละเอียดคู่นี้ในระบบ (ตรวจคู่มืออีกครั้ง / สืบค้นเพิ่มเติม)", "");
      return;
    }

    paint(found.status || "ND", found.note || "", found.source || "");
  }

  paint("ND", "กำลังค้นหาข้อมูล...", "");
  main();
})();
</script>
</body>
</html>
