<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Result analyze (Compatibility)</title>

  <meta name="theme-color" content="#0ea5a6" />
  <link rel="manifest" href="./static/manifest.webmanifest">
  <link rel="apple-touch-icon" href="./static/icons/icon-192.png">

  <link rel="stylesheet" href="./static/style.css">
  <script defer src="./static/app.js"></script>
</head>

<body class="">
  <div class="container">
    <div class="compat-shell">
      <h1 class="compat-title">
        ตรวจสอบความเข้ากันได้ของยา<br>
        <span>Drug Compatibility</span>
      </h1>

      <div class="compat-card compat-card-wide">
        <h2 class="compat-subtitle">Result analyze</h2>

        <div class="compat-result-header">
          <span class="compat-pill" data-drug-a>Drug A</span>
          <span class="compat-with">with</span>
          <span class="compat-pill" data-drug-b>Drug B</span>
        </div>

        <div class="compat-status-line">
          <span class="compat-status-pill" data-status-code>…</span>
          <span class="compat-status-text" data-status-label>Loading…</span>
        </div>

        <hr>

        <div class="compat-note-block">
          <p class="compat-note-main" data-note-main>กำลังโหลดฐานข้อมูล…</p>
          <p class="compat-note-ref" data-note-ref></p>
        </div>

        <div class="compat-legend" style="margin-top:20px">
          <span class="dot dot-c"></span> C = Compatible / ผสมร่วมได้
          • <span class="dot dot-i"></span> I = Incompatible / ห้ามผสม
          • <span class="dot dot-u"></span> U = Uncertain / ไม่ชัดเจน
          • <span class="dot dot-nd"></span> ND = No data / ไม่มีข้อมูล
        </div>

        <div class="compat-actions" style="margin-top:20px">
          <a href="compatibility.html" class="btn-check">↺ New check</a>
          <a href="index.html" class="btn-home">Home</a>
        </div>

        <!-- debug box (แสดงเฉพาะเมื่อใส่ ?debug=1) -->
        <pre id="dbg" style="display:none;text-align:left;margin-top:14px;padding:10px;border-radius:10px;background:rgba(0,0,0,.08);overflow:auto"></pre>
      </div>
    </div>
<<<<<<< Updated upstream

    
    <div class="compat-status-line">
      <span class="compat-status-pill" data-status-code>ND</span>
      <span class="compat-status-text" data-status-label>Unknown</span>
    </div>

    <hr>

    <div class="compat-note-block">
      <p class="compat-note-main" data-note-main>
        ยังไม่พบรายละเอียดคู่นี้ในระบบ (ตรวจคู่มืออีกครั้ง / สืบค้นเพิ่มเติม)
      </p>
      <p class="compat-note-ref" data-note-ref></p>
    </div>

    <div class="compat-legend" style="margin-top:20px">
      <span class="dot dot-c"></span> C = Compatible / ผสมร่วมได้
      • <span class="dot dot-i"></span> I = Incompatible / ห้ามผสม
      • <span class="dot dot-u"></span> U = Uncertain / ไม่ชัดเจน
      • <span class="dot dot-nd"></span> ND = No data / ไม่มีข้อมูล
    </div>

    <div class="compat-actions" style="margin-top:20px">
      <a href="compatibility.html" class="btn-check">↺ New check</a>
      <a href="index.html" class="btn-home">Home</a>
    </div>
  </div>
</div>


<script>
  (function () {
    var params = new URLSearchParams(window.location.search);

    var drugA = params.get("drug_a") || "Drug A";
    var drugB = params.get("drug_b") || "Drug B";

    var elA = document.querySelector("[data-drug-a]");
    var elB = document.querySelector("[data-drug-b]");
    if (elA) elA.textContent = drugA;
    if (elB) elB.textContent = drugB;

    // ถ้าในอนาคตใส่ status= C/I/U/ND มาด้วย ก็จะ map ให้ด้วย
    var status = params.get("status");
    var sCodeEl = document.querySelector("[data-status-code]");
    var sLabelEl = document.querySelector("[data-status-label]");
    if (status && sCodeEl && sLabelEl) {
      var map = {
        "C": "Compatible / ผสมร่วมได้",
        "I": "Incompatible / ห้ามผสม",
        "U": "Uncertain / ไม่ชัดเจน",
        "ND": "No data / ไม่มีข้อมูล"
      };
      sCodeEl.textContent = status;
      sLabelEl.textContent = map[status] || "Unknown";
    }
  })();
</script>

=======
>>>>>>> Stashed changes
  </div>

  <footer>
    <p>Developed by Sukhontha Boonsookchan | update <span id="buildDate"></span></p>
  </footer>

<script>
(function () {
  // ====== ตั้งค่า build date (แก้ตรงนี้ครั้งเดียวต่อรอบ release) ======
  const BUILD_DATE = "2025-11-30";
  var bd = document.getElementById("buildDate");
  if (bd) bd.textContent = BUILD_DATE;

  // ====== DOM refs ======
  var elA = document.querySelector("[data-drug-a]");
  var elB = document.querySelector("[data-drug-b]");
  var sCodeEl  = document.querySelector("[data-status-code]");
  var sLabelEl = document.querySelector("[data-status-label]");
  var noteMain = document.querySelector("[data-note-main]");
  var noteRef  = document.querySelector("[data-note-ref]");
  var dbg = document.getElementById("dbg");

  function showDebug(msg) {
    var params = new URLSearchParams(location.search);
    if (params.get("debug") !== "1") return;
    dbg.style.display = "block";
    dbg.textContent += msg + "\n";
  }

  // ====== normalize ให้ตรงกับ key ใน compat_lookup.json ======
  function norm(s) {
    return (s || "")
      .toString()
      .normalize("NFKC")
      .toLowerCase()
      .trim()
      .replace(/\s+/g, " ");            // รวมช่องว่าง
  }
  function makeKey(a, b) {
    return norm(a) + "|" + norm(b);
  }

  function paint(code, label, note, source) {
    sCodeEl.textContent  = code || "ND";
    sLabelEl.textContent = label || "No data / ไม่มีข้อมูล";

    noteMain.textContent = note || "ยังไม่พบรายละเอียดคู่นี้ในระบบ (ตรวจคู่มืออีกครั้ง / สืบค้นเพิ่มเติม)";
    noteRef.textContent  = source ? ("Reference: " + source) : "";
  }

  // ====== read query ======
  var params = new URLSearchParams(location.search);
  var drugA = params.get("drug_a") || "Drug A";
  var drugB = params.get("drug_b") || "Drug B";
  if (elA) elA.textContent = drugA;
  if (elB) elB.textContent = drugB;

  // ถ้าไม่มีค่า query ให้จบ
  if (!params.get("drug_a") || !params.get("drug_b")) {
    paint("ND", "Missing input", "กรุณากลับไปเลือกยา A และ B ใหม่", "");
    return;
  }

  // ====== fetch lookup ======
  (async function run() {
    try {
      // กัน cache ค้าง: ผูกกับ BUILD_DATE (ไม่ใช้ Date.now() จะไม่ยิงทุกครั้งจนเปลือง)
      var url = "./static/compat_lookup.json?v=" + encodeURIComponent(BUILD_DATE);

      showDebug("fetch: " + url);
      var res = await fetch(url, { cache: "no-store" });
      showDebug("status: " + res.status);

      if (!res.ok) throw new Error("fetch compat_lookup.json failed: " + res.status);

      var db = await res.json();
      var k1 = makeKey(drugA, drugB);
      var k2 = makeKey(drugB, drugA);

      showDebug("key1: " + k1);
      showDebug("key2: " + k2);
      showDebug("has key1: " + !!db[k1]);
      showDebug("has key2: " + !!db[k2]);

      var hit = db[k1] || db[k2];
      if (!hit) {
        paint("ND", "No data / ไม่มีข้อมูล", "ยังไม่พบรายละเอียดคู่นี้ในระบบ (ตรวจคู่มืออีกครั้ง / สืบค้นเพิ่มเติม)", "");
        return;
      }

      // hit = {status, source, note}
      var code = (hit.status || "ND").toString().toUpperCase();
      var labelMap = {
        "C":  "Compatible / ผสมร่วมได้",
        "I":  "Incompatible / ห้ามผสม",
        "U":  "Uncertain / ไม่ชัดเจน",
        "ND": "No data / ไม่มีข้อมูล"
      };

      paint(code, labelMap[code] || "Unknown", hit.note || "", hit.source || "");
    } catch (e) {
      console.error(e);
      showDebug("ERROR: " + (e && e.message ? e.message : String(e)));
      paint("ND", "Load failed", "โหลดฐานข้อมูลไม่สำเร็จ: กรุณาเปิด DevTools > Console ดู error", "");
    }
  })();
})();
</script>
</body>
</html>
