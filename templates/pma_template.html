{# templates/pma_template.html #}
{% extends "base.html" %}
{% block title %}Calculate PMA{% endblock %}
{% block body_class %}pma-page{% endblock %}

{% block content %}

<style>
  .pma-card{
    max-width: 420px;
    margin: 24px auto 16px;
    padding: 18px 18px 20px;
    border-radius: 18px;
    background: rgba(255,255,255,0.86);
    box-shadow: 0 10px 30px rgba(15,23,42,0.25);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
  }
  .pma-title{
    margin: 0 0 16px;
    padding: 10px 16px;
    border-radius: 14px;
    background: linear-gradient(135deg,#0474a4,#059669);
    color:#fff;
    text-align:center;
    font-weight: 900;
    font-size: clamp(20px, 4.4vw, 28px);
    box-shadow: 0 10px 22px rgba(4,47,46,0.35);
    margin-top: 0;
    margin-bottom: 30px;
  }
  .pma-card .form-group{
    margin-bottom: 10px;
    text-align:left;
    font-size: 14px;
  }
  .pma-card label{ font-weight: 600; }
  .pma-inline{
    display:flex;
    align-items:center;
    gap:8px;
    margin-top:4px;
  }
  .pma-inline input[type="number"]{
    flex:1;
    min-width:0;
  }
  .pma-card input[type="number"]{
    width:100%;
    padding:8px 10px;
    border-radius:10px;
    border:1px solid #cbd5e1;
    font-size:14px;
    text-align:center;
  }
  .pma-card input[type="number"]:focus{
    outline:none;
    border-color:#0ea5e9;
    box-shadow:0 0 0 2px rgba(56,189,248,0.35);
  }
  .pma-btn{
    margin-top:14px;
    width:100%;
    padding:10px 0;
    border-radius:12px;
    border:none;
    background:linear-gradient(135deg,#0f766e,#15803d);
    color:#fff;
    font-weight:800;
    cursor:pointer;
    box-shadow:0 6px 0 rgba(15,23,42,0.35);
    transition:transform 0.08s ease, filter 0.15s ease;
  }
  .pma-btn:hover{ filter:brightness(1.04); transform:translateY(-1px); }
  .pma-btn:active{ transform:translateY(1px); }

  .pma-result{
    margin-top:16px;
    padding:12px 10px;
    border-radius:10px;
    background:#f1f5f9;
    border:1px dashed #cbd5e1;
    font-size:14px;
  }
  .pma-result p{ margin:4px 0; }
  .pma-pill{
    display:inline-block;
    padding:2px 6px;
    border-radius:6px;
    background:#0f766e;
    color:#fff;
    font-weight:800;
  }
  .drug-button{
    margin-top:10px;
    width:100%;
    padding:8px 0;
    border-radius:10px;
    border:none;
    background:#1d4ed8;
    color:#fff;
    font-weight:700;
    cursor:pointer;
  }

  .button-group{ text-align:center; margin-top:12px; }

  .back-button {
    display: inline-block;
    margin-top: 20px;
    padding: 10px 20px;
    font-size: 16px;
    text-align: center;
    color: #fff;
    background-color: #f44336;
    border: none;
    border-radius: 10px;
    text-decoration: none;
    box-shadow: 0 4px #999;
  }
  .back-button:hover { background-color: #d32f2f; }
  .back-button:active {
    background-color: #d32f2f;
    box-shadow: 0 4px #666;
    transform: translateY(4px);
  }

  .back-button-secondary {
    display: inline-block;
    margin-top: 20px;
    padding: 10px 20px;
    font-size: 16px;
    text-align: center;
    color: #fff;
    background-color: #008CBA;
    border: none;
    border-radius: 10px;
    text-decoration: none;
    box-shadow: 0 4px #999;
  }
  .back-button-secondary:hover { background-color: #007B9A; }

  .err-box{
    margin-top:10px;
    padding:10px 10px;
    border-radius:10px;
    background:#fee2e2;
    border:1px solid #fecaca;
    color:#b91c1c;
    font-size:14px;
    text-align:left;
  }

  @media (max-width:480px){
    .pma-card{ margin-top:12px; padding:14px 12px 16px; }
    .pma-title{ font-size:20px; padding:8px 12px; margin-bottom: 16px; }
  }
</style>

{# =========================
   โหมด STATIC (GitHub Pages)
   ========================= #}
{% if static_build %}
  <div class="pma-card">
    <h2 class="pma-title">Calculate Postmenstrual Age (PMA)</h2>

    <form id="pma-form" onsubmit="return false;">
      <div class="form-group">
        <label>Gestational Age:</label>
        <div class="pma-inline">
          <input type="number" id="ga_weeks" placeholder="Weeks" min="0" inputmode="numeric">
          <span>wks</span>
          <input type="number" id="ga_days" placeholder="Days" min="0" max="6" inputmode="numeric">
          <span>day</span>
        </div>
      </div>

      <div class="form-group">
        <label>Postnatal Age (Days):</label>
        <div class="pma-inline">
          <input type="number" id="postnatal_days" placeholder="Days" min="0" inputmode="numeric">
          <span>day</span>
        </div>
      </div>

      <div class="form-group">
        <label>Birth Weight (kg):</label>
        <div class="pma-inline">
          <input type="number" id="bw" placeholder="kg" step="0.001" min="0" inputmode="decimal">
          <span>kg</span>
        </div>
      </div>

      <div id="pma-err-static" class="err-box" style="display:none"></div>

      <button type="button" class="pma-btn" id="pma-calc-btn">
        Calculate PMA
      </button>
    </form>

    <div id="pma-result-static" class="pma-result" style="display:none">
      <p>PMA:
        <span class="pma-pill">
          <span id="pma_res_weeks"></span> weeks
          <span id="pma_res_days"></span> days
        </span>
      </p>
      <p>Calc.:
        <b style="color:#0f766e">
          <span id="pma_res_calc"></span> weeks
        </b>
      </p>
      <p>Postnatal Age:
        <b style="color:#0f766e">
          <span id="pma_res_pna"></span> days
        </b>
      </p>
      <p>Birth Weight (BW):
        <b style="color:#0f766e">
          <span id="pma_res_bw"></span> kg
        </b>
      </p>
    </div>

    <button id="drug-btn-static"
            type="button"
            class="drug-button"
            style="display:none"
            disabled>
      คำนวณยา
    </button>
  </div>

  <div class="button-group">
    <a href="javascript:history.back()" class="back-button-secondary">Back</a>
    <a href="{{ u('index') }}" class="back-button">Back to Home</a>
  </div>

  <script>
    // =========================
    // STATIC Navigation mapping
    // =========================
    // บังคับปลายทางเป็นไฟล์ .html สำหรับ GitHub Pages
    const DRUG_CALC_URL = "./drug_calculation.html";

    const KEY = "nmc_ctx_v1";
    let lastPMA = null;

    function showErr(msg){
      const box = document.getElementById("pma-err-static");
      box.textContent = msg || "";
      box.style.display = msg ? "block" : "none";
    }

    function asInt(id){
      const v = document.getElementById(id).value;
      if (v === "" || v === null || v === undefined) return null;
      const n = Number(v);
      if (!Number.isFinite(n)) return null;
      return Math.trunc(n);
    }

    function asFloat(id){
      const v = document.getElementById(id).value;
      if (v === "" || v === null || v === undefined) return null;
      const n = Number(v);
      if (!Number.isFinite(n)) return null;
      return n;
    }

    function normalizeGA(weeks, days){
      // days อาจเกิน 6 → แปลงเป็น weeks เพิ่ม
      const w0 = Math.max(0, weeks || 0);
      const d0 = Math.max(0, days  || 0);
      const extraW = Math.floor(d0 / 7);
      const d = d0 % 7;
      const w = w0 + extraW;
      return { w, d };
    }

    function calculatePMAStatic() {
      showErr("");

      const gaWeeksRaw = asInt("ga_weeks");
      const gaDaysRaw  = asInt("ga_days");
      const pnaRaw     = asInt("postnatal_days");
      const bwRaw      = asFloat("bw");

      // minimal validation
      if (gaWeeksRaw === null) return showErr("กรุณากรอก Gestational Age (weeks)");
      if (gaDaysRaw  === null) return showErr("กรุณากรอก Gestational Age (days)");
      if (pnaRaw     === null) return showErr("กรุณากรอก Postnatal Age (days)");
      if (bwRaw      === null) return showErr("กรุณากรอก Birth Weight (kg)");

      if (gaWeeksRaw < 0 || gaDaysRaw < 0 || pnaRaw < 0 || bwRaw < 0) {
        return showErr("ค่าที่กรอกต้องไม่ติดลบ");
      }

      const gaN = normalizeGA(gaWeeksRaw, gaDaysRaw);
      // sync normalized back to inputs (กัน day เกิน 6)
      document.getElementById("ga_weeks").value = gaN.w;
      document.getElementById("ga_days").value  = gaN.d;

      const totalDays = gaN.w * 7 + gaN.d + pnaRaw;
      const pmaWeeks  = Math.floor(totalDays / 7);
      const pmaDays   = totalDays % 7;
      const calc      = Number((pmaWeeks + pmaDays / 7).toFixed(2)); // เก็บละเอียดขึ้น

      document.getElementById("pma_res_weeks").textContent = pmaWeeks;
      document.getElementById("pma_res_days").textContent  = pmaDays;
      document.getElementById("pma_res_calc").textContent  = calc.toFixed(2);
      document.getElementById("pma_res_pna").textContent   = pnaRaw;
      document.getElementById("pma_res_bw").textContent    = bwRaw.toFixed(3);

      document.getElementById("pma-result-static").style.display = "block";

      // เก็บค่าไว้ใช้ตอนกดปุ่มคำนวณยา
      lastPMA = {
        pma_weeks: pmaWeeks,
        pma_days:  pmaDays,
        postnatal_days: pnaRaw,
        bw: Number(bwRaw.toFixed(3)),
        calc: calc
      };

      // เก็บลง sessionStorage กันค่าไหลต่อหน้า dose
      try { sessionStorage.setItem(KEY, JSON.stringify(lastPMA)); } catch(e){}

      const btn = document.getElementById("drug-btn-static");
      btn.style.display = "block";
      btn.disabled = false;
    }

    document.getElementById("pma-calc-btn").addEventListener("click", calculatePMAStatic);

    document.getElementById("drug-btn-static").addEventListener("click", function () {
      if (!lastPMA) return;

      const params = new URLSearchParams({
        pma_weeks:      String(lastPMA.pma_weeks),
        pma_days:       String(lastPMA.pma_days),
        postnatal_days: String(lastPMA.postnatal_days),
        bw:             String(lastPMA.bw),
        calc:           String(lastPMA.calc)
      });

      window.location.href = DRUG_CALC_URL + "?" + params.toString();
    });

    // ถ้ามี ctx เดิมใน session → เติมค่าให้ฟอร์ม (ช่วย user กลับมาแล้วไม่ต้องกรอกใหม่)
    (function hydrateFromSession(){
      try{
        const raw = sessionStorage.getItem(KEY);
        if(!raw) return;
        const ctx = JSON.parse(raw);
        if(!ctx) return;
        // ไม่บังคับใส่กลับทุกครั้ง แต่ช่วยเติม BW/PNA ถ้ามี
        if (Number.isFinite(Number(ctx.postnatal_days))) document.getElementById("postnatal_days").value = ctx.postnatal_days;
        if (Number.isFinite(Number(ctx.bw))) document.getElementById("bw").value = ctx.bw;
      }catch(e){}
    })();
  </script>

{# =========================
   โหมด FLASK (server side)
   ========================= #}
{% else %}
  <div class="pma-card">
    <h2 class="pma-title">Calculate Postmenstrual Age (PMA)</h2>

    <form method="post" action="{{ u('calculate_pma_route') }}">
      <div class="form-group">
        <label>Gestational Age:</label>
        <div class="pma-inline">
          <input type="number"
                 name="gestational_age_weeks"
                 placeholder="Weeks"
                 required min="0"
                 value="{{ ga_w_val|default('', true) }}">
          <span>wks</span>
          <input type="number"
                 name="gestational_age_days"
                 placeholder="Days"
                 required min="0"
                 value="{{ ga_d_val|default('', true) }}">
          <span>day</span>
        </div>
      </div>

      <div class="form-group">
        <label>Postnatal Age (Days):</label>
        <div class="pma-inline">
          <input type="number"
                 name="postnatal_age_days"
                 placeholder="Days"
                 required min="0"
                 value="{{ pna_d_val|default('', true) }}">
          <span>day</span>
        </div>
      </div>

      <div class="form-group">
        <label>Birth Weight (kg):</label>
        <div class="pma-inline">
          <input type="number"
                 name="bw"
                 placeholder="kg"
                 step="0.001"
                 required min="0"
                 value="{{ bw|default('', true) }}">
          <span>kg</span>
        </div>
      </div>

      <button type="submit" class="pma-btn">Calculate PMA</button>
    </form>

    {% if error %}
      <div class="err-box">{{ error }}</div>
    {% endif %}

    {% if pma_weeks is not none and pma_days is not none %}
      <div class="pma-result">
        <p>PMA:
          <span class="pma-pill">
            {{ pma_weeks }} weeks {{ pma_days }} days
          </span>
        </p>

        {# calc_unit บางทีคุณเก็บเป็น "32.6" บางทีเก็บเป็น "weeks" → กันพลาดด้วย default #}
        <p>Calc.:
          <b style="color:#0f766e">
            {{ calc_unit|default('-', true) }}
          </b>
        </p>

        <p>Postnatal Age:
          <b style="color:#0f766e">
            {{ postnatal_days if postnatal_days is not none else '-' }} days
          </b>
        </p>

        <p>Birth Weight (BW):
          <b style="color:#0f766e">
            {% if bw is defined and bw is not none %}
              {{ bw|fmt(3) }} kg
            {% else %}
              -
            {% endif %}
          </b>
        </p>

        {# ส่งค่าไป drug_calculation route #}
        <form method="post" action="{{ u('drug_calculation') }}">
          <input type="hidden" name="pma_weeks" value="{{ pma_weeks }}">
          <input type="hidden" name="pma_days"  value="{{ pma_days }}">
          <input type="hidden" name="postnatal_days" value="{{ postnatal_days if postnatal_days is not none else '' }}">
          <input type="hidden" name="bw" value="{{ bw if bw is defined and bw is not none else '' }}">
          {# แนะนำให้ส่ง calc เป็น "ตัวเลขสัปดาห์ทศนิยม" ถ้าคุณมีตัวเลขนั้น #}
          <input type="hidden" name="calc" value="{{ calc_unit|default('', true) }}">
          <button class="drug-button" type="submit">คำนวณยา</button>
        </form>
      </div>
    {% endif %}
  </div>

  <div class="button-group">
    <a href="javascript:history.back()" class="back-button-secondary">Back</a>
    <a href="{{ u('index') }}" class="back-button">Back to Home</a>
  </div>
{% endif %}

{% endblock %}
