{% extends "base.html" %}
{% block title %}Result analyze (Compatibility){% endblock %}

{% block extra_head %}
<style>
  /* ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏ß‡∏° */
  .compat-wrap{
    max-width: 1100px;              /* ‚úÖ ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô */
    margin: 0 auto;
    padding: 18px 12px 170px;
  }

  /* ‚úÖ ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Å‡∏£‡∏≠‡∏ö‡∏Ç‡∏≤‡∏ß‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô ‡πÅ‡∏•‡∏∞‡∏™‡∏π‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ */
  .compat-card{
    background: rgba(255,255,255,.92);
    backdrop-filter: blur(6px);
    border: 1px solid rgba(15,23,42,.12);
    border-radius: 22px;
    padding: 18px 18px 20px;
    box-shadow: 0 12px 34px rgba(15,23,42,.20);
    text-align:left;

    min-height: 320px;              /* ‚úÖ ‡∏™‡∏π‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ */
  }

  .compat-top{
    display:flex; gap:12px; flex-wrap:wrap;
    align-items:center; justify-content:space-between
  }
  .compat-title{font-weight:900;font-size:20px;line-height:1.25}
  .compat-sub{font-size:13px;opacity:.85}

  .pill{
    display:inline-flex;align-items:center;gap:8px;
    padding:9px 14px;border-radius:999px;font-weight:900;
    border:1px solid rgba(15,23,42,.14);
    background: rgba(255,255,255,.86);
    user-select:none;
  }
  .pill .dot{width:10px;height:10px;border-radius:50%;}
  .pill.ok  .dot{background:#16a34a;}
  .pill.bad .dot{background:#dc2626;}
  .pill.warn .dot{background:#f59e0b;}
  .pill.nd  .dot{background:#64748b;}

  .hr{border:none;border-top:1px solid rgba(15,23,42,.12);margin:14px 0}

  .note-box{
    white-space:pre-wrap;
    line-height:1.65;
    font-size:15px;                 /* ‚úÖ ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô */
    min-height: 120px;              /* ‚úÖ ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô */
  }

  .meta{
    margin-top:10px;
    font-size:12px;
    opacity:.78;
    line-height:1.45;
  }

  .hint{
    margin-top:12px;
    background: rgba(255,255,255,.80);
    border:1px dashed rgba(15,23,42,.25);
    border-radius: 14px;
    padding: 12px;
    text-align:left;
    font-size:14px;
  }

  .btn-row{
    margin-top:16px;
    display:flex;
    gap:10px;
    justify-content:center;
    flex-wrap:wrap;
  }
  .btn{
    border:0;border-radius:999px;
    padding:10px 16px;
    font-weight:900;
    cursor:pointer;
    text-decoration:none;
    display:inline-flex;
    align-items:center;
    gap:8px;
    box-shadow:0 10px 20px rgba(15,23,42,.12);
  }
  .btn.primary{background:#16a34a;color:#fff;}
  .btn.ghost{background:rgba(15,23,42,.06);color:#0f172a;}
</style>
{% endblock %}

{% block content %}
<div class="compat-wrap">
  <h2 class="title-badge">Result analyze (Compatibility)</h2>

  <div class="compat-card" id="resultCard">
    <div class="compat-top">
      <div>
        <div class="compat-sub">Drug pair</div>
        <div class="compat-title"><span id="drugA">‚Äî</span> √ó <span id="drugB">‚Äî</span></div>
      </div>
      <div>
        <span class="pill nd" id="statusPill">
          <span class="dot"></span><span id="statusText">Loading</span>
        </span>
      </div>
    </div>

    <div class="hr"></div>

    <div style="font-weight:900;margin-bottom:6px">Note</div>
    <div class="note-box" id="noteText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶</div>

    <div class="meta" id="metaText"></div>

    <div class="btn-row">
      <a class="btn primary" href="./compatibility.html">‚Üª New check</a>
      <a class="btn ghost" href="./index.html">üè† Home</a>
    </div>
  </div>

  <div class="hint" id="noQueryHint" style="display:none">
    ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå <b>drug_a</b> ‡πÅ‡∏•‡∏∞ <b>drug_b</b> ‡πÉ‡∏ô URL<br>
    ‡πÉ‡∏´‡πâ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏≤ ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏Å‡∏î ‚ÄúAnalyze/Result‚Äù ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const drugAEl = $("drugA");
  const drugBEl = $("drugB");
  const pillEl  = $("statusPill");
  const statusEl= $("statusText");
  const noteEl  = $("noteText");
  const metaEl  = $("metaText");
  const noQuery = $("noQueryHint");

  const setPill = (kind, text) => {
    pillEl.classList.remove("ok","bad","warn","nd");
    pillEl.classList.add(kind);
    statusEl.textContent = text;
  };

  // ‚úÖ ‡∏ó‡∏≥ normalization ‡πÉ‡∏´‡πâ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™ match ‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô
  const norm = (s) => (s || "")
    .toString()
    .trim()
    .replace(/\s+/g, " ");

  const keyLower = (a,b) => `${norm(a)}||${norm(b)}`.toLowerCase();
  const keyLowerAlt = (a,b) => `${norm(a)}|${norm(b)}`.toLowerCase(); // ‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ build ‡πÉ‡∏ä‡πâ |

  async function fetchFirst(urls){
    for (const url of urls){
      try{
        const bust = (url.includes("?") ? "&" : "?") + "v=" + Date.now();
        const r = await fetch(url + bust, {cache:"no-store"});
        if (!r.ok) continue;
        return {data: await r.json(), used:url};
      }catch(e){ }
    }
    return null;
  }

  function extractRecord(data, a, b){
    if (!data) return null;

    // 1) mapping object
    if (typeof data === "object" && !Array.isArray(data)) {
      const k1 = keyLower(a,b);
      const k2 = keyLower(b,a);
      const k1b= keyLowerAlt(a,b);
      const k2b= keyLowerAlt(b,a);
      return data[k1] || data[k2] || data[k1b] || data[k2b] || null;
    }

    // 2) array records
    if (Array.isArray(data)) {
      const aL = norm(a).toLowerCase();
      const bL = norm(b).toLowerCase();
      return data.find(x => {
        const da = norm(x.drug_a || x.a || "").toLowerCase();
        const db = norm(x.drug_b || x.b || "").toLowerCase();
        return (da===aL && db===bL) || (da===bL && db===aL);
      }) || null;
    }

    return null;
  }

  function interpretStatus(rec){
    const raw = (rec?.status ?? rec?.result ?? rec?.code ?? "").toString().toUpperCase();

    // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á C/I/U/ND ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ï‡πá‡∏°
    if (raw === "C" || raw.includes("COMPAT")) return {kind:"ok", text:"Compatible"};
    if (raw === "I" || raw.includes("INCOMPAT")) return {kind:"bad", text:"Incompatible"};
    if (raw === "U" || raw.includes("UNCERTAIN") || raw.includes("CAUTION")) return {kind:"warn", text:"Uncertain"};
    if (raw === "ND" || raw.includes("NO DATA") || raw.includes("UNKNOWN")) return {kind:"nd", text:"ND"};
    return {kind:"nd", text:"ND"};
  }

  function pickNote(rec){
    // ‚úÖ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö field ‡∏à‡∏≤‡∏Å seed_compatibility.json
    return (
      rec?.summary_th ||
      rec?.note_th ||
      rec?.summary_en ||
      rec?.note ||
      rec?.detail ||
      rec?.details ||
      ""
    );
  }

  function pickRef(rec){
    return rec?.reference || rec?.ref || rec?.source || "";
  }

  async function main(){
    const qs = new URLSearchParams(location.search);
    const drugA = qs.get("drug_a") || qs.get("a") || "";
    const drugB = qs.get("drug_b") || qs.get("b") || "";

    drugAEl.textContent = norm(drugA) || "‚Äî";
    drugBEl.textContent = norm(drugB) || "‚Äî";

    if (!norm(drugA) || !norm(drugB)) {
      setPill("nd","ND");
      noteEl.textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Drug A ‡πÅ‡∏•‡∏∞ Drug B ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤";
      metaEl.textContent = "No query params";
      noQuery.style.display = "block";
      return;
    }

    // ‚úÖ ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á Flask ‡πÅ‡∏•‡∏∞ Pages
    const flaskUrl = "{{ url_for('static', filename='compat_lookup.json') }}";
    const pagesUrl = "./static/compat_lookup.json";

    const candidates = [
      pagesUrl,
      flaskUrl,
      "/static/compat_lookup.json",
      "./static/compat_lookup.min.json",
    ].filter(Boolean);

    const got = await fetchFirst(candidates);

    if (!got){
      setPill("nd","ND");
      noteEl.textContent =
        "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ (compat_lookup.json)\n" +
        "‚Ä¢ GitHub Pages: ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà docs/static/compat_lookup.json ‡πÅ‡∏•‡∏∞ deploy ‡πÅ‡∏•‡πâ‡∏ß\n" +
        "‚Ä¢ Flask: ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤ /static/compat_lookup.json ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ";
      metaEl.textContent = "Data source: not available";
      return;
    }

    const {data, used} = got;
    const rec = extractRecord(data, drugA, drugB);

    if (!rec){
      setPill("nd","ND");
      noteEl.textContent =
        "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏π‡πà‡∏¢‡∏≤‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•\n" +
        "‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÄ‡∏ä‡∏¥‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢: ‡∏ñ‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (ND)' ‡πÅ‡∏•‡∏∞‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏£‡πà‡∏ß‡∏°‡∏™‡∏≤‡∏¢ (Y-site) ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏°‡∏µ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô";
      metaEl.textContent =
        "Data source: " + used + " | lookup_key=" + keyLower(drugA,drugB);
      return;
    }

    const st = interpretStatus(rec);
    setPill(st.kind, st.text);

    const note = pickNote(rec);
    noteEl.textContent = note || "‚Äî";

    const ref = pickRef(rec);
    metaEl.textContent = "Reference: " + (ref || "‚Äî") + " | Source: " + used;
  }

  main().catch(err => {
    console.error(err);
    setPill("nd","ND");
    noteEl.textContent = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä/‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏Ñ‡∏ä ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà";
    metaEl.textContent = "Runtime error (see console)";
  });

})();
</script>
{% endblock %}
