<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Acyclovir Calculation</title>
  <style>
    .hidden{display:none!important}
    /* … (CSS อื่น ๆ ของคุณคงเดิม) … */
  </style>
</head>
<body>

  <div class="title-badge">Acyclovir (250mg/5ml)</div>

  <div class="container">

    <!-- ฟอร์มคำนวณรอบแรก -->
    <div class="calc-box">
      <form id="calcForm"
            action="{{ (not static_build) and u('acyclovir_route') or '#' }}"
            method="{{ (not static_build) and 'post' or 'get' }}"
            class="calc-row">
        <input type="hidden" name="action" value="dose" />
        <div class="dose-row">
          <label for="dose">กรอกขนาดยา (mg):</label>
          <input type="number" id="dose" name="dose" placeholder="ขนาดยา (mg)"
                 required step="0.01"
                 value="{{ dose if dose is not none else '' }}">
        </div>
        <button type="submit" class="btn btn-blue">คำนวณ</button>
      </form>
    </div>

    <!-- กล่องผลลัพธ์ 1 และ 2 (เริ่มซ่อนถ้า static_build หรือยังไม่มีผล) -->
    <div id="resultBox"
         class="result {% if static_build or (result_ml_1 is none and result_ml_2 is none) %}hidden{% endif %}">
      <p><b>Order:</b> Acyclovir <span id="doseText">{{ dose if dose is not none else '' }}</span> mg</p>

      <p><b>ขั้นตอนที่ 1: คำนวณปริมาณยา (สต็อก 250 mg / 5 ml)</b></p>
      <p>สูตร <span class="mono">(mg × 5) / 250</span> ⇒
         <span class="mono"><span id="doseA">{{ dose if dose is not none else '' }}</span> × 5 / 250 = <span id="r1">{{ result_ml_1 if result_ml_1 is not none else '' }}</span> ml</span></p>

      <p><b>ขั้นตอนที่ 2: คำนวณปริมาณสารละลายเป้าหมาย (5 mg/ml)</b></p>
      <p>สูตร <span class="mono">(mg × 1) / 5</span> ⇒
         <span class="mono"><span id="doseB">{{ dose if dose is not none else '' }}</span> × 1 / 5 = <span id="r2">{{ result_ml_2 if result_ml_2 is not none else '' }}</span> ml</span></p>

      <hr style="border:none;border-top:1px dashed #cfe3ff;margin:10px 0">

      <p class="highlight"><b>ปริมาณยา (ตัวสาร):</b> <span id="substance">{{ result_ml_1 if result_ml_1 is not none else '0.0' }}</span> ml</p>
      <p class="highlight"><b>ปริมาณตัวทำละลาย:</b>
        <span id="diluent">
          {% if result_ml_1 is not none and result_ml_2 is not none %}
            {{ (result_ml_2 - result_ml_1)|round(2) }}
          {% else %}
            0.0
          {% endif %}
        </span> ml
        <span class="muted">
          (<span id="r2a">{{ result_ml_2 if result_ml_2 is not none else '0.0' }}</span> − <span id="r1a">{{ result_ml_1 if result_ml_1 is not none else '0.0' }}</span>)
        </span>
      </p>
      <p><b>ปริมาณยาที่บริหารเข้าทารก:</b> <span id="giveR2">{{ result_ml_2 if result_ml_2 is not none else '0.0' }}</span> ml → <b>drip 1 hr.</b></p>
    </div>

    <!-- ฟอร์มเลือกตัวคูณ (เริ่มซ่อนถ้า static_build หรือยังไม่มีผลรอบแรก) -->
    <div id="multBox"
         class="calc-box {% if static_build or (result_ml_1 is none and result_ml_2 is none) %}hidden{% endif %}">
      <form id="multForm"
            action="{{ (not static_build) and u('acyclovir_route') or '#' }}"
            method="{{ (not static_build) and 'post' or 'get' }}"
            class="calc-row" style="gap:12px">
        <input type="hidden" name="dose" id="multDose" value="{{ dose if dose is not none else '' }}">
        <label for="multiplication">เลือกเงื่อนไข:</label>
        <select name="multiplication" id="multiplication" required>
          <option value="1.5">1.5 เท่า</option>
          <option value="2">2 เท่า</option>
          <option value="2.5">2.5 เท่า</option>
          <option value="3">3 เท่า</option>
          <option value="3.5">3.5 เท่า</option>
          <option value="4">4 เท่า</option>
          <option value="4.5">4.5 เท่า</option>
          <option value="5">5 เท่า</option>
        </select>
        <button type="submit" class="btn btn-blue" name="calculate_multiplication">คำนวณการคูณ</button>
      </form>
    </div>

    <!-- ผลคูณ (เริ่มซ่อนถ้ายังไม่คูณ) -->
    <div id="finalBox"
         class="result {% if static_build or (final_result_1 is none and final_result_2 is none) %}hidden{% endif %}">
      <p><b>ผลลัพธ์หลังจากคูณ <span id="multX">{{ multiplication if multiplication is not none else '' }}</span> เท่า</b></p>
      <div style="background:#ffffff;border:1px solid #e5efff;border-radius:10px;padding:12px;">
        <p><span id="m1">{{ multiplication if multiplication is not none else '' }}</span> × <span id="r1b">{{ result_ml_1 if result_ml_1 is not none else '' }}</span> ml =
           <span class="pill"><b id="f1">{{ final_result_1 if final_result_1 is not none else '' }}</b></span> ml
           <span class="muted">(จากสูตร: (dose × 5) / 250)</span></p>

        <p><span id="m2">{{ multiplication if multiplication is not none else '' }}</span> × <span id="r2b">{{ result_ml_2 if result_ml_2 is not none else '' }}</span> ml =
           <span class="pill"><b id="f2">{{ final_result_2 if final_result_2 is not none else '' }}</b></span> ml
           <span class="muted">(จากสูตร: (dose × 1) / 5)</span></p>
      </div>
    </div>

    <!-- … เนื้อหาอธิบาย/คำเตือนคงเดิม … -->

  </div>

  <footer class="page-footer">
    <p>Developed by Sukhontha Boonsookchan | update {{ UPDATE_DATE }}</p>
  </footer>

  <div class="float-actions">
    <a href="{{ u('medication_administration') }}" class="btn btn-cyan">Back</a>
    <a href="{{ u('index') }}" class="btn btn-red">Back to Home</a>
  </div>

  <!-- JS: คำนวณฝั่ง client เมื่อเป็น static_build (กัน 405) -->
  <script>
    var isStatic = {{ static_build|default(true)|tojson }};

    function round2(x){ return Math.round((x + Number.EPSILON) * 100)/100; }

    function showBox(id){ document.getElementById(id)?.classList.remove('hidden'); }
    function hideBox(id){ document.getElementById(id)?.classList.add('hidden'); }

    function setText(id, v){ var el=document.getElementById(id); if(el) el.textContent = v; }

    if(isStatic){
      // รอบแรก
      document.getElementById('calcForm')?.addEventListener('submit', function(ev){
        ev.preventDefault();
        var dose = parseFloat(document.getElementById('dose').value || '0');
        if(!(dose>0)){ hideBox('resultBox'); hideBox('multBox'); hideBox('finalBox'); return; }

        var r1 = round2((dose*5)/250);
        var r2 = round2(dose/5);

        setText('doseText', dose);
        setText('doseA', dose);
        setText('doseB', dose);
        setText('r1', r1); setText('r1a', r1);
        setText('r2', r2); setText('r2a', r2);
        setText('substance', r1);
        setText('diluent', round2(r2 - r1));
        setText('giveR2', r2);

        document.getElementById('multDose').value = dose;

        showBox('resultBox');
        showBox('multBox');
        hideBox('finalBox');
      });

      // รอบคูณ
      document.getElementById('multForm')?.addEventListener('submit', function(ev){
        ev.preventDefault();
        var dose = parseFloat(document.getElementById('multDose').value || '0');
        var mult = parseFloat(document.getElementById('multiplication').value || '0');
        if(!(dose>0) || !(mult>0)){ hideBox('finalBox'); return; }

        var r1 = round2((dose*5)/250);
        var r2 = round2(dose/5);
        var f1 = round2(r1*mult);
        var f2 = round2(r2*mult);

        setText('multX', mult);
        setText('m1', mult); setText('m2', mult);
        setText('r1b', r1);  setText('r2b', r2);
        setText('f1', f1);   setText('f2', f2);

        showBox('finalBox');
      });
    }
  </script>
</body>
</html>
