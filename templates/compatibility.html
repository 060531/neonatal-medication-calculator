{% extends "base.html" %}
{% block title %}ตรวจสอบ Compatibility{% endblock %}

{% block content %}
<style>
  .compat-page{
    display:block;
    text-align:initial;
    width:100%;
  }

  .compat-shell{
    box-sizing:border-box;
    width:100%;
    max-width:1040px;
    margin:24px auto 16px;
    padding-inline:clamp(12px,4vw,24px);
    padding-left:max(clamp(10px,4vw,20px),env(safe-area-inset-left));
    padding-right:max(clamp(10px,4vw,20px),env(safe-area-inset-right));
  }
  .compat-shell, .compat-shell *{
    font-size:clamp(13px,2.6vw,16px);
    line-height:1.35;
  }

  .title-wrap{
    display:grid;
    place-items:center;
    text-align:center;
  }
  .title-banner{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    padding:12px 18px;
    border-radius:14px;
    color:#fff;
    font-weight:800;
    font-size:clamp(18px,4vw,26px);
    background:linear-gradient(135deg,#0ea5a6,#0b74d0);
    box-shadow:0 10px 24px rgba(0,0,0,.25);
    margin-inline:auto;
    margin-bottom:16px;
    max-width:92vw;
  }

  .card-wrap{
    width:100%;
    max-width:1000px;
    margin-inline:auto;
  }
  .glass-card{
    background:rgba(255,255,255,0.95);
    border:1px solid rgba(15,23,42,.08);
    border-radius:16px;
    box-shadow:0 10px 28px rgba(2,8,23,.15);
    padding:clamp(14px,3vw,22px);
    color:#0f172a;
    margin-bottom:8px;
  }

  .form-grid{
    display:grid;
    gap:12px 16px;
    align-items:end;
    grid-template-columns:1fr;
    grid-template-areas:
      "a"
      "b"
      "actions";
  }
  .field-a{ grid-area:a; }
  .field-b{ grid-area:b; }
  .actions{
    grid-area:actions;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    justify-content:center;
  }
  @media (min-width:820px){
    .form-grid{
      grid-template-columns:1fr 1fr;
      grid-template-areas:
        "a b"
        "actions actions";
    }
  }

  label{
    font-weight:700;
    margin:0 6px 6px 2px;
    display:inline-block;
  }
  select{
    width:100%;
    min-width:0;
    padding:10px 12px;
    border-radius:10px;
    border:1px solid #cbd5e1;
    background:#fff;
    color:#0f172a;
    font-size:inherit;
  }

  .btn{
    display:inline-block;
    padding:clamp(8px,1.6vw,10px) clamp(12px,2.4vw,16px);
    border-radius:10px;
    font-weight:800;
    border:0;
    cursor:pointer;
    white-space:nowrap;
    text-decoration:none;
  }
  .btn-primary{
    background:#0ea5a6;
    color:#fff;
  }
  .btn-secondary{
    background:#e2e8f0;
    color:#0f172a;
  }
  .btn:hover{
    filter:brightness(.95);
  }

  .compat-result{
    margin-top:16px;
    padding:14px 18px;
    border-radius:12px;
    text-align:center;
    border:1px solid #e2e8f0;
    background:rgba(255,255,255,0.9);
    font-weight:500;
  }
  .compat-result.compat-C{
    background:rgba(22,163,74,0.10);
    border-color:#16a34a;
    color:#064e3b;
  }
  .compat-result.compat-I{
    background:rgba(220,38,38,0.10);
    border-color:#dc2626;
    color:#7f1d1d;
  }
  .compat-result.compat-U{
    background:rgba(245,158,11,0.12);
    border-color:#f59e0b;
    color:#78350f;
  }
  .compat-result.compat-ND{
    background:rgba(37,99,235,0.10);
    border-color:#2563eb;
    color:#1e3a8a;
  }

  .hidden{ display:none !important; }

  .legend{
    display:flex;
    flex-wrap:wrap;
    justify-content:center;
    align-items:center;
    gap:10px 14px;
    margin-top:12px;
    color:#334155;
    font-size:clamp(10px,1.4vw,12px);
    line-height:1.25;
  }
  .legend .item{
    display:flex;
    align-items:center;
    gap:6px;
    white-space:nowrap;
  }
  .dot{
    width:10px;
    height:10px;
    border-radius:50%;
    display:inline-block;
  }
  .dot.C{ background:#16a34a; }
  .dot.I{ background:#dc2626; }
  .dot.U{ background:#f59e0b; }
  .dot.ND{ background:#2563eb; }

  @media (min-width:1200px){
    .legend{
      flex-wrap:nowrap;
      gap:18px;
      font-size:10px;
    }
    .dot{ width:9px; height:9px; }
  }
  @media (min-width:1600px){
    .legend{
      font-size:9px;
      gap:20px;
    }
    .dot{ width:8px; height:8px; }
  }
</style>

{# ถ้า build_static_compat ไม่ส่ง fallback_names มา → ใช้ชุด default นี้ #}
{% if fallback_names is not defined %}
{% set fallback_names = [
  "Acyclovir","Amikacin","Aminophylline","Amoxicillin / Clavimoxy",
  "Amphotericin B","Ampicillin","Benzathine penicillin G","Calcium gluconate",
  "Cefazolin","Cefotaxime","Ceftazidime","Ciprofloxacin","Clindamycin",
  "Cloxacillin","Colistin","Dexamethasone","Dobutamine","Dopamine","Fentanyl",
  "Furosemide","Gentamicin","Hydrocortisone","Insulin Human Regular",
  "Levofloxacin","Meropenem","Metronidazole (Flagyl)","Midazolam",
  "Midazolam + Fentanyl","Morphine","Nimbex (Cisatracurium)","Omeprazole",
  "Penicillin G sodium","Phenobarbital","Phenytoin (Dilantin)","Remdesivir",
  "Sul-am®","Sulbactam","Sulperazone","Tazocin","Unasyn","Vancomycin"
] %}
{% endif %}

<div class="compat-page">
  <div class="compat-shell">
    <div class="title-wrap">
      <div class="title-banner">
        ตรวจสอบความเข้ากันได้ของยา (Compatibility)
      </div>
    </div>

    <div class="card-wrap">
      <div class="glass-card">
        {% if use_static %}
          <form method="get" action="#">
        {% else %}
          <form method="post" action="{{ url_for('core.compatibility_page') }}">
        {% endif %}
          <div class="form-grid">
            <!-- ยา A -->
            <div class="field-a">
              <label for="drug_a">ยา A</label>
              <select id="drug_a" name="drug_a" required>
                <option value="">-- เลือกยา --</option>
                {% if drugs %}
                  {% for d in drugs %}
                    <option value="{{ d.id }}"
                      {% if selected_drug_id and (selected_drug_id|string) == (d.id|string) %}selected{% endif %}>
                      {{ d.generic_name }}
                    </option>
                  {% endfor %}
                {% else %}
                  {% for name in fallback_names %}
                    <option value="{{ loop.index }}">{{ name }}</option>
                  {% endfor %}
                {% endif %}
              </select>
            </div>

            <!-- ยา B -->
            <div class="field-b">
              <label for="drug_b">ยา B</label>
              <select id="drug_b" name="drug_b" required>
                <option value="">-- เลือกยา --</option>
                {% if drugs %}
                  {% for d in drugs %}
                    <option value="{{ d.id }}"
                      {% if selected_co_drug_id and (selected_co_drug_id|string) == (d.id|string) %}selected{% endif %}>
                      {{ d.generic_name }}
                    </option>
                  {% endfor %}
                {% else %}
                  {% for name in fallback_names %}
                    <option value="{{ loop.index }}">{{ name }}</option>
                  {% endfor %}
                {% endif %}
              </select>
            </div>

            <!-- ปุ่ม -->
            <div class="actions">
              <button type="submit" class="btn btn-primary">
                ตรวจสอบ
              </button>

              {% set home_href = (URL_MAP['index']
                                  if (use_static and URL_MAP is defined)
                                  else url_for('core.index')) %}
              <a href="{{ home_href }}" class="btn btn-secondary">
                กลับหน้า Home
              </a>
            </div>
          </div>
        </form>

        <!-- กล่องผลลัพธ์ (ฝั่ง Flask render server-side) -->
        <div id="compat-result-box"
             class="compat-result {% if status_code %}compat-{{ status_code }}{% else %}hidden{% endif %}">
          {% if status_code %}
            <p style="margin:0 0 4px 0;">
              ผลการตรวจสอบ:
              <strong>{{ drug_a_name or 'ยา A' }}</strong>
              +
              <strong>{{ drug_b_name or 'ยา B' }}</strong>
              →
              <strong>{{ status_code }}</strong>
            </p>
            <p style="margin:0 0 4px 0;">
              {{ status_text }}
            </p>
            {% if compat and compat.source %}
              <p style="margin:0;font-size:12px;">อ้างอิง: {{ compat.source }}</p>
            {% endif %}
            {% if compat and compat.note %}
              <p style="margin:0;font-size:12px;">หมายเหตุ: {{ compat.note }}</p>
            {% endif %}
          {% endif %}
        </div>

        <!-- Legend -->
        <div class="legend">
          <div class="item">
            <span class="dot C"></span>
            C = Compatible / ผสมร่วมได้
          </div>
          <div class="item">
            <span class="dot I"></span>
            I = Incompatible / ห้ามผสม
          </div>
          <div class="item">
            <span class="dot U"></span>
            U = Uncertain / ไม่ชัดเจน
          </div>
          <div class="item">
            <span class="dot ND"></span>
            ND = No data / ไม่มีข้อมูล
          </div>
        </div>

        {# ===== ฝั่ง Static: สร้าง STATIC_COMPAT จาก compat_pairs ที่ build_static_compat ส่งมา ===== #}
        {% if use_static and compat_pairs is defined and compat_pairs %}
        <script>
        // map ข้อมูลคู่ยา → code/text/source/note
        const STATIC_COMPAT = {
          {% for row in compat_pairs %}
          {{ (row.drug_a|lower ~ '|' ~ row.drug_b|lower)|tojson }}: {
            code: {{ row.status|tojson }},
            text: {{ (
              'Compatible / ผสมร่วมได้'  if row.status == 'C' else
              'Incompatible / ห้ามผสม'   if row.status == 'I' else
              'Uncertain / ไม่ชัดเจน'    if row.status == 'U' else
              'No data / ไม่มีข้อมูล'
            )|tojson }},
            source: {{ (row.source or '')|tojson }},
            note: {{ (row.note or '')|tojson }}
          }{% if not loop.last %},{% endif %}
          {% endfor %}
        };
        </script>

        <script>
        (function(){
          if (!window.STATIC_COMPAT) return;

          function norm(s){
            return String(s || "").trim().toLowerCase();
          }

          var form = document.querySelector(".compat-page form");
          var box  = document.getElementById("compat-result-box");
          if (!form || !box) return;

          form.addEventListener("submit", function(ev){
            ev.preventDefault();

            var selA = document.getElementById("drug_a");
            var selB = document.getElementById("drug_b");
            if (!selA || !selB || !selA.value || !selB.value) return;

            var nameA = selA.options[selA.selectedIndex].text;
            var nameB = selB.options[selB.selectedIndex].text;

            var key1 = norm(nameA) + "|" + norm(nameB);
            var key2 = norm(nameB) + "|" + norm(nameA);
            var data = STATIC_COMPAT[key1] || STATIC_COMPAT[key2];

            var code, html;
            if (!data){
              code = "ND";
              html =
                "<p style='margin:0 0 4px 0;'>ไม่พบข้อมูลคู่นี้ในไฟล์ static</p>" +
                "<p style='margin:0 0 4px 0;'>No data / ไม่มีข้อมูล</p>";
            }else{
              code = data.code || "ND";
              var text = data.text || "No data / ไม่มีข้อมูล";

              html =
                "<p style='margin:0 0 4px 0;'>ผลการตรวจสอบ: <strong>" +
                nameA + "</strong> + <strong>" + nameB +
                "</strong> → <strong>" + code + "</strong></p>" +
                "<p style='margin:0 0 4px 0;'>" + text + "</p>";

              if (data.source){
                html += "<p style='margin:0;font-size:12px;'>อ้างอิง: " + data.source + "</p>";
              }
              if (data.note){
                html += "<p style='margin:0;font-size:12px;'>หมายเหตุ: " + data.note + "</p>";
              }
            }

            box.className = "compat-result compat-" + code;
            box.innerHTML = html;
            box.classList.remove("hidden");
            box.scrollIntoView({ behavior:"smooth", block:"center" });
          });
        })();
        </script>
        {% endif %}

      </div>
    </div>
  </div>
</div>
{% endblock %}
