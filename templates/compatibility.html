{% extends "base.html" %}

{% block title %}ตรวจสอบความเข้ากันได้ของยา (Compatibility){% endblock %}

{% block content %}
<div class="compat-shell">
  <h1 class="compat-title">
    ตรวจสอบความเข้ากันได้ของยา<br>
    <span>Drug Compatibility</span>
  </h1>

  {# โหมด static = build ลง docs (GitHub Pages) #}
  {% set is_static = static_build if static_build is defined else False %}

  {# fallback รายชื่อยาเมื่อไม่มีตัวแปร drugs (กรณี static) #}
  {% set fallback_labels = [
    'Acyclovir',
    'Amikacin',
    'Aminophylline',
    'Amoxicillin / Clavimoxy',
    'Amphotericin B',
    'Amphotericin b',
    'Ampicillin',
    'Benzathine penicillin G',
    'Calcium gluconate',
    'Cefazolin',
    'Cefotaxime',
    'Ceftazidime',
    'Ciprofloxacin',
    'Clindamycin',
    'Cloxacillin',
    'Colistin',
    'Dexamethasone',
    'Dobutamine',
    'Dopamine',
    'Fentanyl',
    'Furosemide',
    'Gentamicin',
    'Hydrocortisone',
    'Insulin Human Regular',
    'Levofloxacin',
    'Meropenem',
    'Metronidazole (Flagyl)',
    'Midazolam',
    'Midazolam + Fentanyl',
    'Morphine',
    'Nimbex (Cisatracurium)',
    'Omeprazole',
    'Penicillin G sodium',
    'Phenobarbital',
    'Phenytoin (Dilantin)',
    'Remdesivir',
    'Sul-am®',
    'Sulbactam',
    'Sulperazone',
    'Tazocin',
    'Unasyn',
    'Vancomycin'
  ] %}

  <div class="compat-card">
    <form
      class="compat-form"
      method="{{ 'get' if is_static else 'post' }}"
      action="{% if is_static %}compatibility_result.html{% else %}{{ url_for('core.compatibility_page') }}{% endif %}"
    >
      <div class="compat-row">

        {# -------- ยา A -------- #}
        <div class="compat-field">
          <label for="drug_a">ยา A</label>
          <select id="drug_a" name="drug_a" class="compat-select" required>
            <option value="">-- เลือกยา --</option>

            {% if (not is_static) and drugs is defined and drugs %}
              {# โหมด Flask + DB: ใช้ id จากฐานข้อมูล #}
              {% for d in drugs %}
                {% set label =
                  d.generic_name if d.generic_name is defined
                  else (d.name if d.name is defined
                  else (d.label if d.label is defined else '')) %}
                {% set did = d.id if d.id is defined else (d.value if d.value is defined else '') %}
                <option value="{{ did }}"
                  {% if selected_drug_id is defined
                        and selected_drug_id is not none
                        and (selected_drug_id|string) == (did|string) %}
                    selected
                  {% endif %}
                >{{ label }}</option>
              {% endfor %}
            {% else %}
              {# โหมด static: ใช้ชื่อยาเป็น value ตรง ๆ #}
              {% for label in fallback_labels %}
                <option value="{{ label }}">{{ label }}</option>
              {% endfor %}
            {% endif %}
          </select>
        </div>

        {# -------- ยา B -------- #}
        <div class="compat-field">
          <label for="drug_b">ยา B</label>
          <select id="drug_b" name="drug_b" class="compat-select" required>
            <option value="">-- เลือกยา --</option>

            {% if (not is_static) and drugs is defined and drugs %}
              {% for d in drugs %}
                {% set label =
                  d.generic_name if d.generic_name is defined
                  else (d.name if d.name is defined
                  else (d.label if d.label is defined else '')) %}
                {% set did = d.id if d.id is defined else (d.value if d.value is defined else '') %}
                <option value="{{ did }}"
                  {% if selected_co_drug_id is defined
                        and selected_co_drug_id is not none
                        and (selected_co_drug_id|string) == (did|string) %}
                    selected
                  {% endif %}
                >{{ label }}</option>
              {% endfor %}
            {% else %}
              {% for label in fallback_labels %}
                <option value="{{ label }}">{{ label }}</option>
              {% endfor %}
            {% endif %}
          </select>
        </div>

      </div>

      <div class="compat-actions">
        <button type="submit" class="btn-check">ตรวจสอบ</button>
        <a href="{{ url_for('core.index') }}" class="btn-home">กลับหน้า Home</a>
      </div>
    </form>

    {# โหมด Flask: แสดงผลลัพธ์ #}
    {% if not is_static %}
      {% if compat is not none %}
        <div class="compat-result compat-result-{{ status_code|lower }}">
          <p class="compat-pair">
            {{ drug_a_name or 'Drug A' }} + {{ drug_b_name or 'Drug B' }}
            → <strong>{{ status_code }}</strong>
            {% if status_text %} ({{ status_text }}){% endif %}
          </p>

          {% if compat is defined and compat and compat.note %}
            <p class="compat-note">{{ compat.note }}</p>
          {% endif %}
          {% if compat is defined and compat and compat.source %}
            <p class="compat-source">อ้างอิง: {{ compat.source }}</p>
          {% endif %}
        </div>

      {% elif selected_drug_id and selected_co_drug_id %}
        <div class="compat-result compat-result-nd">
          <p>ไม่พบข้อมูลคู่นี้ในฐานข้อมูล</p>
          <p class="compat-note">No data / ไม่มีข้อมูล</p>
        </div>

      {% else %}
        <p class="compat-hint">
          เลือกยา A และยา B แล้วกด “ตรวจสอบ” เพื่อดูผลลัพธ์
        </p>
      {% endif %}
    {% else %}
      {# โหมด static: หน้าที่นี่มีเฉพาะฟอร์ม ให้ผลลัพธ์ไปอยู่ compatibility_result.html #}
      <p class="compat-hint">
        เลือกยา A และยา B แล้วกด “ตรวจสอบ” เพื่อดูผลลัพธ์
      </p>
    {% endif %}

    <div class="compat-legend">
      <span class="dot dot-c"></span> C = Compatible / ผสมร่วมได้
      • <span class="dot dot-i"></span> I = Incompatible / ห้ามผสม
      • <span class="dot dot-u"></span> U = Uncertain / ไม่ชัดเจน
      • <span class="dot dot-nd"></span> ND = No data / ไม่มีข้อมูล
    </div>
  </div>
</div>
{% endblock %}
