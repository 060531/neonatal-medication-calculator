cat > templates/_dose_ctx_block.html <<'HTML'
<!-- ===== Dose ctx runtime (Flask + GitHub Pages) ===== -->
<script>
(function () {
  function loadScript(src){
    return new Promise((resolve,reject)=>{
      const s=document.createElement("script");
      s.src=src; s.defer=true;
      s.onload=()=>resolve(src);
      s.onerror=reject;
      document.head.appendChild(s);
    });
  }
  async function loadAny(list){
    for (const src of list){
      try { return await loadScript(src); } catch(e) {}
    }
    throw new Error("Cannot load any: " + list.join(", "));
  }

  window.__loadDoseDeps = async function(){
    // patient_ctx.js -> provides window.NMC
    await loadAny(["/static/patient_ctx.js","./static/patient_ctx.js"]);
    // dose_page.js -> provides window.DosePage
    await loadAny(["/static/dose_page.js","./static/dose_page.js"]);
  };
})();
</script>

<script>
(async function(){
  try{
    await window.__loadDoseDeps();
    if (window.DosePage && typeof window.DosePage.runAuto === "function") {
      window.DosePage.runAuto();
    }
  }catch(e){
    console.warn("Dose deps not loaded / runAuto failed:", e);
  }
})();
</script>
HTML
