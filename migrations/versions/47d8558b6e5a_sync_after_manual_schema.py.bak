"""sync after manual schema

Revision ID: 47d8558b6e5a
Revises: 114c6b58e00a
Create Date: 2025-11-10 19:26:33.083484

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy import inspect


# revision identifiers, used by Alembic.
revision = '47d8558b6e5a'
down_revision = '114c6b58e00a'
branch_labels = None
depends_on = None


    # --- normalize compatibility schema ---
    bind = op.get_bind()
    insp = inspect(bind)
    cols = {c['name'] for c in insp.get_columns('compatibility')}
    with op.batch_alter_table('compatibility', schema=None) as batch_op:
        if 'a' not in cols:
            batch_op.add_column(sa.Column('a', sa.String(length=128)))
        if 'b' not in cols:
            batch_op.add_column(sa.Column('b', sa.String(length=128)))
        for old in ('drug_id','co_drug_id','note'):
            if old in cols:
                batch_op.drop_column(old)
    # ### commands auto generated by Alembic - please adjust! ###
    bind = op.get_bind()
insp = inspect(bind)
if not insp.has_table('access_log'):
    op.create_table('access_log',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('path', sa.String(length=255), nullable=True),
        sa.Column('method', sa.String(length=10), nullable=True),
        sa.PrimaryKeyConstraint('id')
        )
    op.create_table('drug',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=120), nullable=False),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('name')
    )
    op.drop_table('drugs')
    op.drop_table('access_logs')
    with op.batch_alter_table('compatibility', schema=None) as batch_op:
        batch_op.add_column(sa.Column('a', sa.String(length=120), nullable=False))
        batch_op.add_column(sa.Column('b', sa.String(length=120), nullable=False))
        batch_op.alter_column('status',
               existing_type=sa.VARCHAR(length=32),
               type_=sa.String(length=10),
               existing_nullable=False)
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.drop_column('co_drug_id')
        batch_op.drop_column('drug_id')
        batch_op.drop_column('note')

    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('compatibility', schema=None) as batch_op:
        batch_op.add_column(sa.Column('note', sa.TEXT(), nullable=True))
        batch_op.add_column(sa.Column('drug_id', sa.INTEGER(), nullable=False))
        batch_op.add_column(sa.Column('co_drug_id', sa.INTEGER(), nullable=False))
        batch_op.create_foreign_key(None, 'drugs', ['drug_id'], ['id'])
        batch_op.create_foreign_key(None, 'drugs', ['co_drug_id'], ['id'])
        batch_op.alter_column('status',
               existing_type=sa.String(length=10),
               type_=sa.VARCHAR(length=32),
               existing_nullable=False)
        batch_op.drop_column('b')
        batch_op.drop_column('a')

    op.create_table('access_logs',
    sa.Column('id', sa.INTEGER(), nullable=False),
    sa.Column('timestamp', sa.DATETIME(), nullable=False),
    sa.Column('endpoint', sa.VARCHAR(length=128), nullable=False),
    sa.Column('method', sa.VARCHAR(length=8), nullable=False),
    sa.Column('remote_addr', sa.VARCHAR(length=45), nullable=True),
    sa.Column('user_agent', sa.VARCHAR(length=256), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('drugs',
    sa.Column('id', sa.INTEGER(), nullable=False),
    sa.Column('generic_name', sa.VARCHAR(length=128), nullable=False),
    sa.Column('brand_name', sa.VARCHAR(length=128), nullable=True),
    sa.Column('category', sa.VARCHAR(length=64), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('generic_name')
    )
    op.drop_table('drug')
    op.drop_table('access_log')
    # ### end Alembic commands ###
